<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Secret Coder : Upload Lesson Files</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <!-- Favicon -->
    <link href="img/icon.png" rel="icon">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

    <style>
        .upload-area {
            border: 2px dashed #fb873f;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #fff;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            background: #fff5f0;
            border-color: #fb873f;
        }

        .upload-area.dragover {
            background: #fff5f0;
            border-color: #fb873f;
            transform: scale(1.02);
        }

        .file-preview {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            margin: 10px 0;
            background: white;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .file-icon {
            font-size: 24px;
            margin-right: 15px;
        }

        .file-info {
            flex: 1;
        }

        .file-size {
            color: #6c757d;
            font-size: 12px;
        }

        .progress-bar {
            height: 8px;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <h2 class="mb-4" style="color: #fb873f;">
                    <i class="fa fa-upload me-2"></i>Upload Files cho Bài Học
                </h2>

                <!-- Lesson Selection -->
                <div class="card mb-4">
                    <div class="card-body">
                        <label class="form-label">Chọn Bài Học</label>
                        <select id="lessonSelect" class="form-select">
                            <option value="">-- Chọn bài học --</option>
                        </select>
                    </div>
                </div>

                <!-- Upload Forms -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fa fa-video me-2"></i>Upload Video (MP4)</h5>
                    </div>
                    <div class="card-body">
                        <div class="upload-area" id="videoUploadArea">
                            <i class="fa fa-video fa-3x mb-3" style="color: #fb873f;"></i>
                            <p class="mb-2">Kéo thả file video vào đây hoặc click để chọn</p>
                            <p class="text-muted small">Hỗ trợ: MP4 (Tối đa 500MB)</p>
                            <input type="file" id="videoInput" accept="video/mp4,video/mpeg" style="display: none;">
                        </div>
                        <div id="videoPreview" class="file-preview" style="display: none;">
                            <div class="file-item">
                                <i class="fa fa-video file-icon text-danger"></i>
                                <div class="file-info">
                                    <div class="fw-bold" id="videoFileName"></div>
                                    <div class="file-size" id="videoFileSize"></div>
                                    <div class="progress mt-2" style="display: none;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                             role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-danger" onclick="removeFile('video')">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fa fa-headphones me-2"></i>Upload Audio (MP3)</h5>
                    </div>
                    <div class="card-body">
                        <div class="upload-area" id="audioUploadArea">
                            <i class="fa fa-headphones fa-3x mb-3" style="color: #28a745;"></i>
                            <p class="mb-2">Kéo thả file audio vào đây hoặc click để chọn</p>
                            <p class="text-muted small">Hỗ trợ: MP3 (Tối đa 500MB)</p>
                            <input type="file" id="audioInput" accept="audio/mpeg,audio/mp3" style="display: none;">
                        </div>
                        <div id="audioPreview" class="file-preview" style="display: none;">
                            <div class="file-item">
                                <i class="fa fa-headphones file-icon text-success"></i>
                                <div class="file-info">
                                    <div class="fw-bold" id="audioFileName"></div>
                                    <div class="file-size" id="audioFileSize"></div>
                                    <div class="progress mt-2" style="display: none;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                             role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-danger" onclick="removeFile('audio')">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="fa fa-file-pdf me-2"></i>Upload PDF</h5>
                    </div>
                    <div class="card-body">
                        <div class="upload-area" id="pdfUploadArea">
                            <i class="fa fa-file-pdf fa-3x mb-3" style="color: #dc3545;"></i>
                            <p class="mb-2">Kéo thả file PDF vào đây hoặc click để chọn</p>
                            <p class="text-muted small">Hỗ trợ: PDF (Tối đa 500MB)</p>
                            <input type="file" id="pdfInput" accept="application/pdf" style="display: none;">
                        </div>
                        <div id="pdfPreview" class="file-preview" style="display: none;">
                            <div class="file-item">
                                <i class="fa fa-file-pdf file-icon text-danger"></i>
                                <div class="file-info">
                                    <div class="fw-bold" id="pdfFileName"></div>
                                    <div class="file-size" id="pdfFileSize"></div>
                                    <div class="progress mt-2" style="display: none;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-danger" 
                                             role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-danger" onclick="removeFile('pdf')">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Button -->
                <div class="text-center">
                    <button class="btn btn-primary btn-lg px-5" id="uploadBtn" onclick="uploadFiles()" disabled>
                        <i class="fa fa-upload me-2"></i>Upload Files
                    </button>
                </div>

                <!-- Alert Messages -->
                <div id="alertContainer" class="mt-4"></div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script>
        let selectedFiles = {
            video: null,
            audio: null,
            pdf: null
        };

        // Check authentication
        if (!API.isAuthenticated()) {
            window.location.href = 'login.html';
        }

        // Load lessons (you need to implement this based on your course structure)
        async function loadLessons() {
            // Example: Load lessons from a course
            // const courseId = 'your-course-id';
            // const lessons = await API.getCourseLessons(courseId);
            // Populate select dropdown
        }

        // Setup upload areas
        ['video', 'audio', 'pdf'].forEach(type => {
            const area = document.getElementById(`${type}UploadArea`);
            const input = document.getElementById(`${type}Input`);

            // Click to select
            area.addEventListener('click', () => input.click());

            // File selected
            input.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    handleFileSelect(type, e.target.files[0]);
                }
            });

            // Drag and drop
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('dragover');
            });

            area.addEventListener('dragleave', () => {
                area.classList.remove('dragover');
            });

            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) {
                    // Validate file type
                    const validTypes = {
                        video: ['video/mp4', 'video/mpeg'],
                        audio: ['audio/mpeg', 'audio/mp3'],
                        pdf: ['application/pdf']
                    };
                    if (validTypes[type].includes(file.type)) {
                        handleFileSelect(type, file);
                        input.files = e.dataTransfer.files;
                    } else {
                        showAlert('Loại file không hợp lệ!', 'danger');
                    }
                }
            });
        });

        function handleFileSelect(type, file) {
            selectedFiles[type] = file;
            
            // Show preview
            const preview = document.getElementById(`${type}Preview`);
            const fileName = document.getElementById(`${type}FileName`);
            const fileSize = document.getElementById(`${type}FileSize`);
            
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            preview.style.display = 'block';
            
            // Enable upload button
            document.getElementById('uploadBtn').disabled = false;
        }

        function removeFile(type) {
            selectedFiles[type] = null;
            document.getElementById(`${type}Preview`).style.display = 'none';
            document.getElementById(`${type}Input`).value = '';
            
            // Disable upload button if no files
            if (!selectedFiles.video && !selectedFiles.audio && !selectedFiles.pdf) {
                document.getElementById('uploadBtn').disabled = true;
            }
        }

        async function uploadFiles() {
            const lessonId = document.getElementById('lessonSelect').value;
            if (!lessonId) {
                showAlert('Vui lòng chọn bài học!', 'warning');
                return;
            }

            if (!selectedFiles.video && !selectedFiles.audio && !selectedFiles.pdf) {
                showAlert('Vui lòng chọn ít nhất một file!', 'warning');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Đang upload...';

            try {
                // Upload multiple files at once
                const result = await API.uploadMultipleFiles(lessonId, selectedFiles);
                
                if (result.success) {
                    showAlert('Upload thành công!', 'success');
                    // Reset form
                    ['video', 'audio', 'pdf'].forEach(type => {
                        removeFile(type);
                    });
                    document.getElementById('lessonSelect').value = '';
                }
            } catch (error) {
                showAlert('Lỗi: ' + error.message, 'danger');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fa fa-upload me-2"></i>Upload Files';
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Load lessons on page load
        window.addEventListener('DOMContentLoaded', loadLessons);
    </script>
</body>

</html>

